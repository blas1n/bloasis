// Backtesting Service - Runs historical strategy backtests using VectorBT and FinRL engines
// Part of BLOASIS Phase 1 infrastructure for strategy validation
//
// This service provides backtesting capabilities for trading strategies by:
// - Running historical simulations using VectorBT for vectorized operations
// - Supporting FinRL for reinforcement learning-based strategy evaluation
// - Computing performance metrics (Sharpe ratio, max drawdown, win rate)
// - Comparing multiple strategies to find the best performer
//
// Dependencies:
// - Market Data Service: Historical price data for simulation

syntax = "proto3";

package bloasis.backtesting;

import "google/api/annotations.proto";

// BacktestingService provides historical strategy backtesting capabilities
// Uses VectorBT for fast vectorized backtesting and FinRL for RL-based evaluation
service BacktestingService {
  // RunBacktest runs a VectorBT backtest for technical strategies
  // Supports MA Crossover, RSI, and custom strategies
  rpc RunBacktest(BacktestRequest) returns (BacktestResponse) {
    option (google.api.http) = {
      post: "/v1/backtesting/run"
      body: "*"
    };
  }

  // RunRLBacktest runs a FinRL reinforcement learning backtest
  // Supports PPO, A2C, and SAC algorithms
  rpc RunRLBacktest(RLBacktestRequest) returns (BacktestResponse) {
    option (google.api.http) = {
      post: "/v1/backtesting/rl"
      body: "*"
    };
  }

  // GetBacktestResults retrieves results of a completed backtest
  rpc GetBacktestResults(GetResultsRequest) returns (GetResultsResponse) {
    option (google.api.http) = {
      get: "/v1/backtesting/results/{backtest_id}"
    };
  }

  // CompareStrategies compares multiple backtest results
  // Returns ranked comparison with best strategy identified
  rpc CompareStrategies(CompareRequest) returns (CompareResponse) {
    option (google.api.http) = {
      post: "/v1/backtesting/compare"
      body: "*"
    };
  }
}

// BacktestRequest - Request parameters for VectorBT backtest
message BacktestRequest {
  // User identifier who owns this backtest
  string user_id = 1;

  // Symbols to include in the backtest simulation
  // Stock ticker symbols (e.g., ["AAPL", "GOOGL", "MSFT"])
  repeated string symbols = 2;

  // Strategy type to backtest:
  // - "ma_crossover": Moving Average Crossover strategy
  // - "rsi": RSI Overbought/Oversold strategy
  // - "custom": Custom strategy (future extension)
  string strategy_type = 3;

  // Backtest configuration parameters
  BacktestConfig config = 4;

  // Data period for backtest:
  // - "1mo": 1 month
  // - "3mo": 3 months
  // - "6mo": 6 months
  // - "1y": 1 year
  // - "2y": 2 years
  string period = 5;
}

// BacktestConfig - Configuration parameters for backtest simulation
message BacktestConfig {
  // Initial capital for the simulation (USD)
  // Uses double for proto compatibility, converted to Decimal in service
  double initial_cash = 1;

  // Commission per trade (e.g., 0.001 = 0.1%)
  double commission = 2;

  // Slippage per trade (e.g., 0.001 = 0.1%)
  double slippage = 3;

  // Stop loss threshold (e.g., 0.05 = 5% loss triggers exit)
  // Set to 0 to disable
  double stop_loss = 4;

  // Take profit threshold (e.g., 0.10 = 10% gain triggers exit)
  // Set to 0 to disable
  double take_profit = 5;
}

// BacktestResponse - Results of a backtest execution
message BacktestResponse {
  // Unique identifier for this backtest run
  // Format: "backtest_{uuid4}"
  string backtest_id = 1;

  // Per-symbol results
  repeated SymbolResult results = 2;

  // Portfolio-level aggregated metrics
  PortfolioMetrics portfolio_metrics = 3;

  // ISO 8601 timestamp when backtest completed
  string created_at = 4;
}

// SymbolResult - Backtest results for a single symbol
message SymbolResult {
  // Stock ticker symbol
  string symbol = 1;

  // Total return percentage (e.g., 0.25 = 25% return)
  double total_return = 2;

  // Sharpe ratio - risk-adjusted return metric
  // Higher values indicate better risk-adjusted performance
  double sharpe_ratio = 3;

  // Sortino ratio - downside risk-adjusted return
  // Like Sharpe but only considers downside volatility
  double sortino_ratio = 4;

  // Maximum drawdown percentage (e.g., 0.20 = 20% max drawdown)
  // Measures worst peak-to-trough decline
  double max_drawdown = 5;

  // Win rate percentage (e.g., 0.55 = 55% of trades profitable)
  double win_rate = 6;

  // Profit factor (gross profits / gross losses)
  // Values > 1 indicate profitable strategy
  double profit_factor = 7;

  // Total number of trades executed
  int32 total_trades = 8;

  // Average trade duration in days
  double avg_trade_duration_days = 9;

  // Calmar ratio (annualized return / max drawdown)
  double calmar_ratio = 10;

  // Whether strategy passes minimum criteria:
  // - Sharpe >= 0.5
  // - Max Drawdown <= 30%
  // - Win Rate >= 40%
  bool passed = 11;
}

// PortfolioMetrics - Aggregated portfolio-level metrics
message PortfolioMetrics {
  // Average total return across all symbols
  double total_return = 1;

  // Average Sharpe ratio across all symbols
  double sharpe_ratio = 2;

  // Maximum drawdown (worst across all symbols)
  double max_drawdown = 3;

  // Return volatility (std dev of returns)
  double volatility = 4;
}

// RLBacktestRequest - Request parameters for FinRL backtest
message RLBacktestRequest {
  // User identifier
  string user_id = 1;

  // Symbols to include in RL training and testing
  repeated string symbols = 2;

  // RL algorithm to use:
  // - "ppo": Proximal Policy Optimization
  // - "a2c": Advantage Actor-Critic
  // - "sac": Soft Actor-Critic
  string rl_algorithm = 3;

  // Backtest configuration
  BacktestConfig config = 4;

  // Number of training timesteps
  // Higher values = more training but longer execution time
  // Typical range: 10000-100000
  int32 train_timesteps = 5;

  // Data period for backtest
  string period = 6;
}

// GetResultsRequest - Request to retrieve backtest results
message GetResultsRequest {
  // Backtest ID to retrieve
  string backtest_id = 1;
}

// GetResultsResponse - Response containing backtest results
message GetResultsResponse {
  // The backtest results
  BacktestResponse results = 1;
}

// CompareRequest - Request to compare multiple strategies
message CompareRequest {
  // List of backtest IDs to compare
  repeated string backtest_ids = 1;
}

// CompareResponse - Strategy comparison results
message CompareResponse {
  // Ranked comparisons (best first)
  repeated BacktestComparison comparisons = 1;

  // ID of the best performing strategy (highest Sharpe)
  string best_strategy_id = 2;
}

// BacktestComparison - Comparison entry for a single strategy
message BacktestComparison {
  // Backtest ID
  string backtest_id = 1;

  // Strategy name/type
  string strategy_name = 2;

  // Portfolio metrics for comparison
  PortfolioMetrics metrics = 3;

  // Rank (1 = best)
  int32 rank = 4;
}
