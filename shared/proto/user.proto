// User Service - gRPC Protocol Buffer Definition
// Manages user profiles and trading preferences
// Envoy Gateway handles HTTP-to-gRPC transcoding via annotations

syntax = "proto3";

package bloasis.user;

import "google/api/annotations.proto";

// UserService provides user management and preferences
service UserService {
  // GetUser retrieves a user by ID
  rpc GetUser(GetUserRequest) returns (GetUserResponse) {
    option (google.api.http) = {
      get: "/v1/users/{user_id}"
    };
  }

  // CreateUser creates a new user account
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse) {
    option (google.api.http) = {
      post: "/v1/users"
      body: "*"
    };
  }

  // ValidateCredentials validates user email/password (internal only - Auth Service)
  // No HTTP annotation - internal gRPC only
  rpc ValidateCredentials(ValidateCredentialsRequest) returns (ValidateCredentialsResponse);

  // GetUserPreferences retrieves user trading preferences
  rpc GetUserPreferences(GetPreferencesRequest) returns (GetPreferencesResponse) {
    option (google.api.http) = {
      get: "/v1/users/{user_id}/preferences"
    };
  }

  // UpdateUserPreferences updates user trading preferences
  rpc UpdateUserPreferences(UpdatePreferencesRequest) returns (UpdatePreferencesResponse) {
    option (google.api.http) = {
      patch: "/v1/users/{user_id}/preferences"
      body: "*"
    };
  }

  // AI 자동 거래 시작
  rpc StartTrading(StartTradingRequest) returns (StartTradingResponse) {
    option (google.api.http) = {
      post: "/v1/users/{user_id}/trading/start"
      body: "*"
    };
  }

  // AI 자동 거래 중지 (Hard/Soft)
  rpc StopTrading(StopTradingRequest) returns (StopTradingResponse) {
    option (google.api.http) = {
      post: "/v1/users/{user_id}/trading/stop"
      body: "*"
    };
  }

  // 거래 상태 조회
  rpc GetTradingStatus(GetTradingStatusRequest) returns (GetTradingStatusResponse) {
    option (google.api.http) = {
      get: "/v1/users/{user_id}/trading/status"
    };
  }

  // ============================================================================
  // Broker Configuration (Global settings - Phase 1)
  // ============================================================================

  // GetBrokerConfig retrieves broker credentials (internal only - Executor Service)
  // No HTTP annotation - internal gRPC only
  rpc GetBrokerConfig(GetBrokerConfigRequest) returns (GetBrokerConfigResponse);

  // UpdateBrokerConfig saves broker credentials from frontend
  rpc UpdateBrokerConfig(UpdateBrokerConfigRequest) returns (UpdateBrokerConfigResponse) {
    option (google.api.http) = {
      patch: "/v1/settings/broker"
      body: "*"
    };
  }

  // GetBrokerStatus checks broker connection status
  rpc GetBrokerStatus(GetBrokerStatusRequest) returns (GetBrokerStatusResponse) {
    option (google.api.http) = {
      get: "/v1/settings/broker/status"
    };
  }
}

// User represents a user account
message User {
  string user_id = 1;      // UUID
  string email = 2;        // Unique email address
  string name = 3;         // Display name
  string created_at = 4;   // ISO 8601 timestamp
  string updated_at = 5;   // ISO 8601 timestamp
}

// UserPreferences contains user trading preferences
// CRITICAL: Financial values are strings for Decimal precision
message UserPreferences {
  string user_id = 1;
  string risk_profile = 2;           // "conservative", "moderate", "aggressive"
  string max_portfolio_risk = 3;     // Decimal as string (e.g., "0.20")
  string max_position_size = 4;      // Decimal as string (e.g., "0.10")
  repeated string preferred_sectors = 5;  // e.g., ["Technology", "Healthcare"]
  bool enable_notifications = 6;
  bool trading_enabled = 7;          // AI 자동 거래 활성화 여부
}

// GetUserRequest - request to get a user by ID
message GetUserRequest {
  string user_id = 1;
}

// GetUserResponse - response containing user data
message GetUserResponse {
  User user = 1;
}

// CreateUserRequest - request to create a new user
message CreateUserRequest {
  string email = 1;
  string password = 2;  // Will be hashed with bcrypt
  string name = 3;
}

// CreateUserResponse - response after user creation
message CreateUserResponse {
  string user_id = 1;
  User user = 2;
}

// ValidateCredentialsRequest - internal request for Auth Service
message ValidateCredentialsRequest {
  string email = 1;
  string password = 2;
}

// ValidateCredentialsResponse - validation result
message ValidateCredentialsResponse {
  bool valid = 1;
  string user_id = 2;  // Only set if valid=true
}

// GetPreferencesRequest - request to get user preferences
message GetPreferencesRequest {
  string user_id = 1;
}

// GetPreferencesResponse - response containing preferences
message GetPreferencesResponse {
  UserPreferences preferences = 1;
}

// UpdatePreferencesRequest - request to update preferences
message UpdatePreferencesRequest {
  string user_id = 1;
  UserPreferences preferences = 2;
}

// UpdatePreferencesResponse - response after update
message UpdatePreferencesResponse {
  UserPreferences preferences = 1;
}

// StartTradingRequest - request to start AI auto-trading
message StartTradingRequest {
  string user_id = 1;
}

// StartTradingResponse - response after starting trading
message StartTradingResponse {
  bool success = 1;
  string message = 2;
  string timestamp = 3;
}

// StopTradingRequest - request to stop AI auto-trading
message StopTradingRequest {
  string user_id = 1;
  string stop_mode = 2;  // "hard" or "soft" (default: "soft")
}

// StopTradingResponse - response after stopping trading
message StopTradingResponse {
  bool success = 1;
  string message = 2;
  int32 orders_cancelled = 3;
  string timestamp = 4;
}

// GetTradingStatusRequest - request to get trading status
message GetTradingStatusRequest {
  string user_id = 1;
}

// GetTradingStatusResponse - trading status response
message GetTradingStatusResponse {
  bool trading_enabled = 1;
  string status = 2;  // "active", "inactive", "soft_stopped", "hard_stopped"
  string last_changed = 3;
  int32 next_poll_ms = 4;  // Client should wait this many ms before next poll (server-directed)
}

// ============================================================================
// Broker Configuration Messages (Global settings - Phase 1)
// ============================================================================

// GetBrokerConfigRequest - internal request from Executor
message GetBrokerConfigRequest {}

// GetBrokerConfigResponse - decrypted broker credentials
message GetBrokerConfigResponse {
  string alpaca_api_key = 1;
  string alpaca_secret_key = 2;
  bool paper = 3;
  bool configured = 4;  // Whether credentials are set
}

// UpdateBrokerConfigRequest - save broker credentials from frontend
message UpdateBrokerConfigRequest {
  string alpaca_api_key = 1;
  string alpaca_secret_key = 2;
  bool paper = 3;  // Phase 1: always true
}

// UpdateBrokerConfigResponse - save result
message UpdateBrokerConfigResponse {
  bool success = 1;
  string message = 2;
}

// GetBrokerStatusRequest - check broker connection
message GetBrokerStatusRequest {}

// GetBrokerStatusResponse - broker connection status
message GetBrokerStatusResponse {
  bool configured = 1;     // Whether credentials are saved
  bool connected = 2;      // Whether Alpaca API call succeeded
  reserved 3;              // Removed: account_id (not used in Phase 1)
  double equity = 4;       // Account equity (if connected)
  double cash = 5;         // Account cash (if connected)
  string error_message = 6; // Error details (if not connected)
}
