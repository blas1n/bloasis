// Executor Service - Executes trading orders via Alpaca paper trading API
// Part of BLOASIS Phase 1 infrastructure for order execution
//
// This service integrates with Alpaca paper trading API for order execution.
// It acts as the final step in the trading pipeline after strategy generation
// and risk assessment.
//
// Dependencies:
// - Risk Management Service: Must approve strategy before execution
// - Portfolio Service: Tracks positions and available buying power
// - AI Analysis Service: Provides strategy_id with trading signals
//
// Event Publishing (Redpanda):
// - order-filled: Published when an order is successfully filled
// - order-rejected: Published when an order is rejected by the system or broker
//
// Order Status Flow:
// - PENDING: Order submitted, awaiting execution
// - FILLED: Order fully executed at filled_price
// - REJECTED: Order rejected by risk management or broker
// - CANCELLED: Order cancelled by user or system
//
// Note: This service is for paper trading only in Phase 1.
// Live trading integration will be added in Phase 2.

syntax = "proto3";

package bloasis.executor;

import "google/api/annotations.proto";
import "common.proto";

// ExecutorService handles order execution via Alpaca paper trading API
// All orders must pass risk assessment before execution
service ExecutorService {
  // ExecuteOrder submits a trading order for execution
  //
  // The workflow:
  // 1. Validates order parameters (symbol, quantity, order type)
  // 2. Checks available buying power with Portfolio Service
  // 3. Submits order to Alpaca paper trading API
  // 4. Returns order status and execution details
  //
  // Order Types:
  // - MARKET: Execute immediately at current market price
  // - LIMIT: Execute only at specified limit_price or better
  //
  // Events Published:
  // - order-filled: When order is successfully executed
  // - order-rejected: When order is rejected
  //
  // Note: Orders should only be submitted after risk assessment approval
  rpc ExecuteOrder(ExecuteOrderRequest) returns (ExecuteOrderResponse) {
    option (google.api.http) = {
      post: "/v1/executor/execute-order"
      body: "*"
    };
  }

  // GetOrderStatus retrieves the current status of an order
  //
  // Use this to:
  // - Track pending order progress
  // - Verify order completion
  // - Check fill details for completed orders
  //
  // Note: Order status is also available via WebSocket notifications
  rpc GetOrderStatus(GetOrderStatusRequest) returns (GetOrderStatusResponse) {
    option (google.api.http) = {
      get: "/v1/executor/order-status/{order_id}"
    };
  }
}

// ExecuteOrderRequest - Request parameters for order execution
message ExecuteOrderRequest {
  // User identifier who is placing the order
  // Used for position tracking and audit logging
  string user_id = 1;

  // Strategy identifier that generated this trade signal
  // Links order to AI Analysis strategy for tracking
  // Format: "strategy_{user_id}_{timestamp}"
  string strategy_id = 2;

  // Stock ticker symbol to trade (e.g., "AAPL", "GOOGL")
  // Must be a valid symbol supported by Alpaca
  string symbol = 3;

  // Trading action to execute
  // Valid values:
  // - "BUY": Open or add to long position
  // - "SELL": Close or reduce long position
  string action = 4;

  // Number of shares to trade
  // Must be positive integer
  // Will be validated against available buying power (for BUY)
  // or current position size (for SELL)
  int32 quantity = 5;

  // Order type for execution
  // Valid values:
  // - "MARKET": Execute immediately at current market price
  // - "LIMIT": Execute only at limit_price or better
  string order_type = 6;

  // Limit price for LIMIT orders
  // Uses bloasis.common.Money for Decimal precision (critical for trading)
  // Required for LIMIT orders, ignored for MARKET orders
  // For BUY: Order executes only at limit_price or lower
  // For SELL: Order executes only at limit_price or higher
  bloasis.common.Money limit_price = 7;
}

// ExecuteOrderResponse - Result of order execution request
message ExecuteOrderResponse {
  // Unique identifier for this order
  // Format: "order_{user_id}_{timestamp}"
  // Use this ID to track order status
  string order_id = 1;

  // User identifier who placed the order
  // Matches user_id from request
  string user_id = 2;

  // Current order status
  // Valid values:
  // - "PENDING": Order submitted, awaiting execution
  // - "FILLED": Order fully executed
  // - "REJECTED": Order rejected by risk management or broker
  // - "CANCELLED": Order cancelled by user or system
  string status = 3;

  // Price at which the order was filled
  // Uses bloasis.common.Money for Decimal precision (critical for trading)
  // Populated when status is "FILLED"
  // For MARKET orders: Actual execution price
  // For LIMIT orders: Limit price or better
  bloasis.common.Money filled_price = 4;

  // ISO 8601 timestamp when order was processed
  // Example: "2025-01-26T14:30:00Z"
  string timestamp = 5;
}

// GetOrderStatusRequest - Request to check order status
message GetOrderStatusRequest {
  // Unique identifier of the order to query
  // Obtained from ExecuteOrderResponse.order_id
  string order_id = 1;

  // User identifier for authorization
  // Must match the user who placed the order
  string user_id = 2;
}

// GetOrderStatusResponse - Current status of an order
message GetOrderStatusResponse {
  // Unique identifier of the queried order
  string order_id = 1;

  // Current order status
  // Valid values:
  // - "PENDING": Order submitted, awaiting execution
  // - "FILLED": Order fully executed
  // - "REJECTED": Order rejected by risk management or broker
  // - "CANCELLED": Order cancelled by user or system
  string status = 2;

  // Number of shares that have been filled
  // For partially filled orders, this may be less than requested quantity
  // For fully filled orders, this equals the original quantity
  int32 filled_quantity = 3;

  // Price at which shares were filled
  // Uses bloasis.common.Money for Decimal precision (critical for trading)
  // Populated when filled_quantity > 0
  // For multiple fills, this is the weighted average price
  bloasis.common.Money filled_price = 4;

  // ISO 8601 timestamp of last status update
  // Example: "2025-01-26T14:30:00Z"
  string timestamp = 5;
}
