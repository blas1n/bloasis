// Classification Service - Stock Selection Pipeline Stage 1-2
// Part of BLOASIS Tier 2 (shared across all users, cached for 6 hours)
// Provides sector filtering and thematic analysis
//
// Stage 1: Sector Filter - Filters 11 GICS sectors down to 3-7 sectors based on market regime
// Stage 2: Thematic Filter - Ranks investment themes within selected sectors

syntax = "proto3";

package bloasis.classification;

import "google/api/annotations.proto";

// ClassificationService provides sector and thematic filtering
// Results are shared across ALL users (Tier 2) and cached for cost optimization
service ClassificationService {
  // GetSectorAnalysis returns sector analysis based on market regime
  // Stage 1: Filters 11 GICS sectors down to 3-7 sectors
  // Uses Claude for analysis, cached for 6 hours
  rpc GetSectorAnalysis(GetSectorAnalysisRequest) returns (GetSectorAnalysisResponse) {
    option (google.api.http) = {
      get: "/v1/classification/sectors"
    };
  }

  // GetThematicAnalysis returns thematic ranking within selected sectors
  // Stage 2: Ranks investment themes within the filtered sectors
  // Uses Claude for analysis, cached for 6 hours
  rpc GetThematicAnalysis(GetThematicAnalysisRequest) returns (GetThematicAnalysisResponse) {
    option (google.api.http) = {
      post: "/v1/classification/thematic"
      body: "*"
    };
  }

  // GetCandidateSymbols returns candidate symbols from Stage 1+2 pipeline
  // Combined operation: sector filter + thematic analysis -> candidate list
  // Returns top candidate symbols for further strategy analysis
  rpc GetCandidateSymbols(GetCandidateSymbolsRequest) returns (GetCandidateSymbolsResponse) {
    option (google.api.http) = {
      get: "/v1/classification/candidates"
    };
  }
}

// GetSectorAnalysisRequest - Request for sector analysis
message GetSectorAnalysisRequest {
  // Market regime (from Market Regime Service)
  // Values: "crisis", "bear", "bull", "sideways", "recovery"
  string regime = 1;

  // If true, bypass cache and force fresh analysis from Claude
  // Use sparingly to avoid unnecessary API costs
  bool force_refresh = 2;
}

// GetSectorAnalysisResponse - Sector analysis results
message GetSectorAnalysisResponse {
  // List of sector scores (all 11 GICS sectors)
  // Sorted by score (highest first)
  repeated SectorScore sectors = 1;

  // Market regime used for analysis
  string regime = 2;

  // ISO 8601 timestamp of when this analysis was cached
  string cached_at = 3;
}

// SectorScore - Individual sector score
message SectorScore {
  // GICS sector name
  // Values: "Technology", "Healthcare", "Financials", "Consumer Discretionary",
  //         "Industrials", "Communication Services", "Consumer Staples",
  //         "Energy", "Utilities", "Real Estate", "Materials"
  string sector = 1;

  // Sector score (0-100)
  // Higher score = better fit for current market regime
  double score = 2;

  // Rationale for score (from AI or rule-based analysis)
  string rationale = 3;

  // Whether this sector is selected for Stage 2 (top 3-7 sectors)
  bool selected = 4;
}

// GetThematicAnalysisRequest - Request for thematic analysis
message GetThematicAnalysisRequest {
  // Selected sectors from Stage 1 (typically 3-7 sectors)
  repeated string sectors = 1;

  // Market regime (for context)
  string regime = 2;

  // If true, bypass cache and force fresh analysis
  bool force_refresh = 3;
}

// GetThematicAnalysisResponse - Thematic analysis results
message GetThematicAnalysisResponse {
  // List of investment themes ranked by score
  // Sorted by score (highest first)
  repeated ThemeScore themes = 1;

  // ISO 8601 timestamp of when this analysis was cached
  string cached_at = 2;
}

// ThemeScore - Individual theme score
message ThemeScore {
  // Investment theme name
  // Examples: "AI Infrastructure", "Clean Energy", "Digital Payments",
  //           "Biotech Innovation", "Cloud Computing", "Cybersecurity"
  string theme = 1;

  // Sector this theme belongs to
  string sector = 2;

  // Theme score (0-100)
  // Higher score = stronger current relevance
  double score = 3;

  // Rationale for score (from AI or rule-based analysis)
  string rationale = 4;

  // Representative symbols for this theme (3-5 symbols)
  // Examples: ["NVDA", "AMD", "TSM"] for "AI Infrastructure"
  repeated string representative_symbols = 5;
}

// GetCandidateSymbolsRequest - Request for candidate symbols
message GetCandidateSymbolsRequest {
  // Market regime (optional - will fetch from Market Regime Service if not provided)
  string regime = 1;

  // Maximum number of candidate symbols to return (default: 50)
  int32 max_candidates = 2;

  // If true, bypass cache and force fresh analysis
  bool force_refresh = 3;
}

// GetCandidateSymbolsResponse - Candidate symbols from Stage 1+2
message GetCandidateSymbolsResponse {
  // List of candidate symbols with preliminary scoring
  // Sorted by preliminary_score (highest first)
  repeated CandidateSymbol candidates = 1;

  // Selected sectors from Stage 1
  repeated string selected_sectors = 2;

  // Top themes from Stage 2
  repeated string top_themes = 3;

  // Market regime used for analysis
  string regime = 4;
}

// CandidateSymbol - Individual candidate symbol
message CandidateSymbol {
  // Stock symbol (e.g., "AAPL", "MSFT")
  string symbol = 1;

  // Sector classification
  string sector = 2;

  // Primary investment theme
  string theme = 3;

  // Preliminary score from Stage 1+2
  // This score will be refined in Stage 3 (Strategy Service)
  double preliminary_score = 4;
}
